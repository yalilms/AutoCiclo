<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports
              http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="InformePiezas" pageWidth="595" pageHeight="842" columnWidth="535"
              leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">

    <property name="ireport.zoom" value="1.0"/>
    <property name="ireport.x" value="0"/>
    <property name="ireport.y" value="0"/>

    <parameter name="P_CATEGORIA" class="java.lang.String">
        <defaultValueExpression><![CDATA["%"]]></defaultValueExpression>
    </parameter>

    <queryString>
        <![CDATA[SELECT
            p.id_pieza as idPieza,
            p.codigo_pieza as codigoPieza,
            p.nombre,
            p.categoria,
            p.precio_venta as precioVenta,
            COALESCE(SUM(ip.cantidad), 0) as stockReal,
            p.stock_minimo as stockMinimo,
            p.ubicacion_almacen as ubicacionAlmacen,
            p.compatible_marcas as compatibleMarcas,
            p.imagen,
            p.descripcion
        FROM PIEZAS p
        LEFT JOIN INVENTARIO_PIEZAS ip ON p.id_pieza = ip.id_pieza
        WHERE p.categoria LIKE $P{P_CATEGORIA}
        GROUP BY p.id_pieza, p.codigo_pieza, p.nombre, p.categoria, p.precio_venta,
                 p.stock_minimo, p.ubicacion_almacen, p.compatible_marcas, p.imagen, p.descripcion
        ORDER BY p.categoria, p.nombre]]>
    </queryString>

    <field name="idPieza" class="java.lang.Integer"/>
    <field name="codigoPieza" class="java.lang.String"/>
    <field name="nombre" class="java.lang.String"/>
    <field name="categoria" class="java.lang.String"/>
    <field name="precioVenta" class="java.lang.Double"/>
    <field name="stockReal" class="java.lang.Long"/>
    <field name="stockMinimo" class="java.lang.Integer"/>
    <field name="ubicacionAlmacen" class="java.lang.String"/>
    <field name="compatibleMarcas" class="java.lang.String"/>
    <field name="imagen" class="java.lang.String"/>
    <field name="descripcion" class="java.lang.String"/>

    <variable name="TotalPiezas" class="java.lang.Integer" calculation="Count">
        <variableExpression><![CDATA[$F{idPieza}]]></variableExpression>
    </variable>

    <variable name="ValorTotalStock" class="java.lang.Double" calculation="Sum">
        <variableExpression><![CDATA[$F{precioVenta} * $F{stockReal}]]></variableExpression>
    </variable>

    <title>
        <band height="79" splitType="Stretch">
            <staticText>
                <reportElement x="0" y="0" width="555" height="35"/>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="24" isBold="true"/>
                </textElement>
                <text><![CDATA[CATÁLOGO DE PIEZAS - AUTOCICLO]]></text>
            </staticText>
            <textField pattern="dd/MM/yyyy HH:mm">
                <reportElement x="400" y="40" width="155" height="20"/>
                <textElement textAlignment="Right">
                    <font size="10"/>
                </textElement>
                <textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
            </textField>
            <staticText>
                <reportElement x="300" y="40" width="100" height="20"/>
                <textElement textAlignment="Right">
                    <font size="10" isBold="true"/>
                </textElement>
                <text><![CDATA[Fecha de emisión:]]></text>
            </staticText>
            <line>
                <reportElement x="0" y="75" width="555" height="1"/>
            </line>
        </band>
    </title>

    <columnHeader>
        <band height="30" splitType="Stretch">
            <staticText>
                <reportElement mode="Opaque" x="0" y="0" width="60" height="30" forecolor="#FFFFFF" backcolor="#4A90E2"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[Código]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="60" y="0" width="50" height="30" forecolor="#FFFFFF" backcolor="#4A90E2"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[Imagen]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="110" y="0" width="120" height="30" forecolor="#FFFFFF" backcolor="#4A90E2"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[Nombre]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="230" y="0" width="80" height="30" forecolor="#FFFFFF" backcolor="#4A90E2"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[Categoría]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="310" y="0" width="60" height="30" forecolor="#FFFFFF" backcolor="#4A90E2"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[Precio (€)]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="370" y="0" width="45" height="30" forecolor="#FFFFFF" backcolor="#4A90E2"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[Stock]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="415" y="0" width="140" height="30" forecolor="#FFFFFF" backcolor="#4A90E2"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[Ubicación]]></text>
            </staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="50" splitType="Stretch">
            <textField>
                <reportElement x="0" y="0" width="60" height="50"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="8"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{codigoPieza}]]></textFieldExpression>
            </textField>

            <staticText>
                <reportElement x="60" y="0" width="50" height="50"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="16"/>
                </textElement>
                <text><![CDATA[-]]></text>
            </staticText>

            <textField isStretchWithOverflow="true">
                <reportElement x="110" y="0" width="120" height="50"/>
                <box leftPadding="3" rightPadding="3">
                    <pen lineWidth="0.5"/>
                </box>
                <textElement verticalAlignment="Middle">
                    <font size="8"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{nombre}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="230" y="0" width="80" height="50"/>
                <box leftPadding="3">
                    <pen lineWidth="0.5"/>
                </box>
                <textElement verticalAlignment="Middle">
                    <font size="8"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{categoria}]]></textFieldExpression>
            </textField>

            <textField pattern="#,##0.00">
                <reportElement x="310" y="0" width="60" height="50"/>
                <box rightPadding="3">
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font size="8"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{precioVenta}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="370" y="0" width="45" height="50">
                    <printWhenExpression><![CDATA[$F{stockReal} <= $F{stockMinimo}]]></printWhenExpression>
                </reportElement>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="8" isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{stockReal}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="370" y="0" width="45" height="50" forecolor="#000000">
                    <printWhenExpression><![CDATA[$F{stockReal} > $F{stockMinimo}]]></printWhenExpression>
                </reportElement>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="8"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{stockReal}]]></textFieldExpression>
            </textField>

            <textField isStretchWithOverflow="true">
                <reportElement x="415" y="0" width="140" height="50"/>
                <box leftPadding="3" rightPadding="3">
                    <pen lineWidth="0.5"/>
                </box>
                <textElement verticalAlignment="Middle">
                    <font size="8"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{ubicacionAlmacen}]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <pageFooter>
        <band height="30" splitType="Stretch">
            <textField>
                <reportElement x="400" y="10" width="100" height="20"/>
                <textElement textAlignment="Right">
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA["Página " + $V{PAGE_NUMBER} + " de"]]></textFieldExpression>
            </textField>
            <textField evaluationTime="Report">
                <reportElement x="500" y="10" width="55" height="20"/>
                <textElement>
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
            </textField>
            <line>
                <reportElement x="0" y="5" width="555" height="1"/>
            </line>
        </band>
    </pageFooter>

    <summary>
        <band height="70" splitType="Stretch">
            <staticText>
                <reportElement mode="Opaque" x="0" y="10" width="370" height="25" backcolor="#EEEEEE"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font size="11" isBold="true"/>
                </textElement>
                <text><![CDATA[TOTAL DE PIEZAS REGISTRADAS:  ]]></text>
            </staticText>
            <textField>
                <reportElement mode="Opaque" x="370" y="10" width="185" height="25" backcolor="#EEEEEE"/>
                <box leftPadding="5">
                    <pen lineWidth="0.5"/>
                </box>
                <textElement verticalAlignment="Middle">
                    <font size="11" isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{TotalPiezas}]]></textFieldExpression>
            </textField>
            <staticText>
                <reportElement mode="Opaque" x="0" y="35" width="370" height="25" backcolor="#DDDDDD"/>
                <box>
                    <pen lineWidth="0.5"/>
                </box>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font size="11" isBold="true"/>
                </textElement>
                <text><![CDATA[VALOR TOTAL DEL STOCK:  ]]></text>
            </staticText>
            <textField pattern="#,##0.00 €">
                <reportElement mode="Opaque" x="370" y="35" width="185" height="25" backcolor="#DDDDDD"/>
                <box leftPadding="5">
                    <pen lineWidth="0.5"/>
                </box>
                <textElement verticalAlignment="Middle">
                    <font size="11" isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{ValorTotalStock}]]></textFieldExpression>
            </textField>
        </band>
    </summary>
</jasperReport>
